generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                     String                @id @default(uuid())
  email                  String                @unique
  username               String                @unique
  passwordHash           String?
  name                   String?
  bio                    String?
  avatar                 String?
  coverImage             String?
  location               String?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  accountType            String?
  country                String?
  isVerified             Boolean               @default(false)
  profileCompleted       Boolean               @default(false)
  role                   String                @default("user")
  socialLinks            Json?
  website                String?
  unitSystem             String                @default("metric") // "metric" or "imperial"
  cars                   Car[]
  carComments            CarComment[]
  carCommentLikes        CarCommentLike[]
  carFollows             CarFollow[]
  carPhotos              CarPhoto[]
  carPhotoComments       CarPhotoComment[]
  carPhotoCommentLikes   CarPhotoCommentLike[]
  carPhotoRatings        CarPhotoRating[]
  carRatings             CarRating[]
  comments               Comment[]
  commentLikes           CommentLike[]
  organizedEvents        Event[]
  eventAttendances       EventAttendee[]
  following              Follow[]              @relation("follower")
  followers              Follow[]              @relation("following")
  historyNodes           HistoryNode[]
  likes                  Like[]
  listings               Listing[]
  notificationsTriggered Notification[]        @relation("notificationActor")
  notifications          Notification[]        @relation("notifications")
  performanceTimes       PerformanceTime[]
  posts                  Post[]

  // Car Spotting relations
  spots                  CarSpot[]
  spotGuesses            CarSpotGuess[]
  spotRatings            CarSpotRating[]
  spotComments           CarSpotComment[]
}

model CarMake {
  id        String     @id @default(cuid())
  name      String     @unique
  slug      String     @unique
  country   String?
  logo      String?
  isPopular Boolean    @default(false)
  models    CarModel[]
}

model CarModel {
  id          String          @id @default(cuid())
  name        String
  slug        String
  makeId      String
  generations CarGeneration[]
  make        CarMake         @relation(fields: [makeId], references: [id], onDelete: Cascade)

  @@unique([makeId, slug])
  @@index([makeId])
}

model CarGeneration {
  id          String         @id @default(cuid())
  name        String
  displayName String?
  startYear   Int
  endYear     Int?
  bodyType    String?
  image       String?
  modelId     String
  cars        Car[]
  model       CarModel       @relation(fields: [modelId], references: [id], onDelete: Cascade)
  engines     EngineConfig[]

  @@unique([modelId, name])
  @@index([modelId])
}

model EngineConfig {
  id           String        @id @default(cuid())
  name         String
  displacement String?
  fuelType     String
  horsepower   Int?
  torque       Int?
  transmission String?
  drivetrain   String?
  generationId String
  cars         Car[]
  generation   CarGeneration @relation(fields: [generationId], references: [id], onDelete: Cascade)

  @@index([generationId])
}

model Car {
  id               String            @id @default(cuid())
  year             Int
  nickname         String?
  description      String?
  image            String?
  images           String[]          @default([])
  thumbnail        String?
  mileage          Int?
  engine           String?
  transmission     String?
  drivetrain       String?
  fuelType         String?
  horsepower       Int?
  torque           Int?
  color            String?
  purchaseDate     DateTime?
  isPublic         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  curbWeight       Int?
  weightWithDriver Int?
  wheelSizeFront   String?
  wheelSizeRear    String?
  wheelBrand       String?
  wheelModel       String?
  wheelOffset      String?
  tireSizeFront    String?
  tireSizeRear     String?
  tireBrand        String?
  tireModel        String?
  tireCompound     String?
  suspensionType   String?
  suspensionBrand  String?
  suspensionDrop   String?
  brakeFrontSize   String?
  brakeRearSize    String?
  brakeBrand       String?
  brakeType        String?
  modifications    String?
  estimatedHp      Int?
  estimatedTorque  Int?
  dynoVerified     Boolean           @default(false)
  ownerId          String
  generationId     String?
  engineConfigId   String?
  commentsEnabled  Boolean           @default(true)
  dynoProofUrl     String?
  hpVerifiedAt     DateTime?
  hpVerifiedBy     String?

  // Direct make/model for API-based entry (NHTSA)
  make             String?
  model            String?

  // VIN Verification
  vin              String?
  vinVerified      Boolean           @default(false)
  vinVerifiedAt    DateTime?
  vinVerifiedBy    String?
  vinProofUrl      String?           // Photo of VIN plate or registration

  // Torque Verification
  torqueVerified   Boolean           @default(false)
  torqueVerifiedAt DateTime?
  torqueVerifiedBy String?

  // Stock Power Badge (admin can mark as stock even without engineConfig)
  isStockPower     Boolean           @default(false)
  stockMarkedAt    DateTime?
  stockMarkedBy    String?

  // Performance Times Verification (0-100, 0-200, 100-200, 402m)
  // These are stored in PerformanceTime model with status field

  engineConfig     EngineConfig?     @relation(fields: [engineConfigId], references: [id])
  generation       CarGeneration?    @relation(fields: [generationId], references: [id])
  owner            User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  carComments      CarComment[]
  followers        CarFollow[]
  photos           CarPhoto[]
  ratings          CarRating[]
  eventAttendances EventAttendee[]
  historyNodes     HistoryNode[]
  listings         Listing[]
  performanceTimes PerformanceTime[]
  posts            Post[]

  @@index([ownerId])
  @@index([generationId])
}

model Post {
  id                 String        @id @default(cuid())
  title              String
  content            String
  images             String?
  thumbnail          String?
  category           String
  mileage            Int?
  cost               Float?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  authorId           String
  carId              String?
  comments           Comment[]
  linkedHistoryNodes HistoryNode[]
  likes              Like[]
  author             User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  car                Car?          @relation(fields: [carId], references: [id])

  @@index([authorId])
  @@index([carId])
}

model Comment {
  id        String        @id @default(cuid())
  content   String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  authorId  String
  postId    String
  parentId  String?
  author    User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent    Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]     @relation("CommentReplies")
  post      Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  likes     CommentLike[]

  @@index([authorId])
  @@index([postId])
  @@index([parentId])
}

model CommentLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  commentId String
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

model CarComment {
  id        String           @id @default(cuid())
  content   String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  authorId  String
  carId     String
  parentId  String?
  author    User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  car       Car              @relation(fields: [carId], references: [id], onDelete: Cascade)
  parent    CarComment?      @relation("CarCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   CarComment[]     @relation("CarCommentReplies")
  likes     CarCommentLike[]

  @@index([authorId])
  @@index([carId])
  @@index([parentId])
}

model CarCommentLike {
  id        String     @id @default(cuid())
  createdAt DateTime   @default(now())
  userId    String
  commentId String
  comment   CarComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

model Like {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
}

model Follow {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  followerId  String
  followingId String
  follower    User     @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Listing {
  id          String   @id @default(cuid())
  price       Int
  currency    String   @default("EUR")
  description String
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sellerId    String
  carId       String
  car         Car      @relation(fields: [carId], references: [id], onDelete: Cascade)
  seller      User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([carId])
}

model PerformanceTime {
  id         String    @id @default(cuid())
  timeMs     Int
  category   String
  trackId    String?
  proofUrl   String?
  proofType  String?
  status     String    @default("pending")
  reviewedAt DateTime?
  reviewNote String?
  runDate    DateTime  @default(now())
  location   String?
  weather    String?
  altitude   Int?
  carHp      Int?
  carWeight  Int?
  carMods    String?
  carId      String
  userId     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  car        Car       @relation(fields: [carId], references: [id], onDelete: Cascade)
  track      Track?    @relation(fields: [trackId], references: [id])
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([status])
  @@index([carId])
  @@index([userId])
}

model Track {
  id           String            @id @default(cuid())
  name         String
  slug         String            @unique
  country      String?
  lengthMeters Int?
  times        PerformanceTime[]

  @@index([slug])
}

model Event {
  id           String          @id @default(cuid())
  title        String
  description  String?
  type         String          @default("meet")
  location     String
  address      String?
  city         String?
  country      String?
  lat          Float?
  lng          Float?
  date         DateTime
  endDate      DateTime?
  maxAttendees Int?
  isPublic     Boolean         @default(true)
  coverImage   String?
  organizerId  String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  organizer    User            @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  attendees    EventAttendee[]

  @@index([date])
  @@index([city])
  @@index([organizerId])
}

model EventAttendee {
  id             String   @id @default(cuid())
  status         String   @default("going")
  carId          String?
  lookingForRide Boolean  @default(false)
  hasEmptySeat   Boolean  @default(false)
  eventId        String
  userId         String
  createdAt      DateTime @default(now())
  car            Car?     @relation(fields: [carId], references: [id])
  event          Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model CarRating {
  id        String   @id @default(cuid())
  carId     String
  userId    String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  car       Car      @relation(fields: [carId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([carId, userId])
  @@index([carId])
}

model HistoryNode {
  id          String   @id @default(cuid())
  carId       String
  authorId    String
  type        String
  title       String
  description String?
  date        DateTime
  mileage     Int?
  cost        Float?
  positionX   Float    @default(0)
  positionY   Float    @default(0)
  parentId    String?
  postId      String?
  isLocked    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  author      User     @relation(fields: [authorId], references: [id])
  car         Car      @relation(fields: [carId], references: [id], onDelete: Cascade)
  post        Post?    @relation(fields: [postId], references: [id])

  @@index([carId])
  @@index([authorId])
}

model CarFollow {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  followerId String
  carId      String
  car        Car      @relation(fields: [carId], references: [id], onDelete: Cascade)
  follower   User     @relation(fields: [followerId], references: [id], onDelete: Cascade)

  @@unique([followerId, carId])
  @@index([followerId])
  @@index([carId])
}

model CarPhoto {
  id         String            @id @default(cuid())
  url        String
  thumbnail  String?
  caption    String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  carId      String
  uploaderId String
  car        Car               @relation(fields: [carId], references: [id], onDelete: Cascade)
  uploader   User              @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  comments   CarPhotoComment[]
  ratings    CarPhotoRating[]

  @@index([carId])
  @@index([uploaderId])
  @@index([createdAt])
}

model CarPhotoRating {
  id        String   @id @default(cuid())
  rating    Int
  createdAt DateTime @default(now())
  photoId   String
  userId    String
  photo     CarPhoto @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([photoId, userId])
  @@index([photoId])
}

model CarPhotoComment {
  id        String                @id @default(cuid())
  content   String
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  photoId   String
  authorId  String
  parentId  String?
  author    User                  @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent    CarPhotoComment?      @relation("CarPhotoCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   CarPhotoComment[]     @relation("CarPhotoCommentReplies")
  photo     CarPhoto              @relation(fields: [photoId], references: [id], onDelete: Cascade)
  likes     CarPhotoCommentLike[]

  @@index([photoId])
  @@index([authorId])
  @@index([parentId])
}

model CarPhotoCommentLike {
  id        String          @id @default(cuid())
  createdAt DateTime        @default(now())
  userId    String
  commentId String
  comment   CarPhotoComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  actorId   String?
  postId    String?
  carId     String?
  actor     User?    @relation("notificationActor", fields: [actorId], references: [id])
  user      User     @relation("notifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
}

// ==========================================
// CAR SPOTTING FEATURE
// ==========================================

model CarSpot {
  id            String    @id @default(cuid())
  imageUrl      String
  thumbnail     String?
  caption       String?
  latitude      Float?
  longitude     Float?
  locationName  String?
  make          String?
  model         String?
  year          Int?
  isIdentified  Boolean   @default(false)
  isChallenge   Boolean   @default(false)
  revealedAt    DateTime?
  correctAnswer String?
  rarityScore   Int?
  spotterId     String
  spotter       User      @relation(fields: [spotterId], references: [id], onDelete: Cascade)
  guesses       CarSpotGuess[]
  ratings       CarSpotRating[]
  comments      CarSpotComment[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([spotterId])
  @@index([createdAt])
  @@index([isChallenge])
}

model CarSpotGuess {
  id        String    @id @default(cuid())
  make      String
  model     String
  year      Int?
  isCorrect Boolean?
  spotId    String
  spot      CarSpot   @relation(fields: [spotId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())

  @@unique([spotId, userId])
  @@index([spotId])
  @@index([userId])
}

model CarSpotRating {
  id        String   @id @default(cuid())
  rating    Int
  spotId    String
  spot      CarSpot  @relation(fields: [spotId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([spotId, userId])
  @@index([spotId])
}

model CarSpotComment {
  id        String           @id @default(cuid())
  content   String
  spotId    String
  spot      CarSpot          @relation(fields: [spotId], references: [id], onDelete: Cascade)
  authorId  String
  author    User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    CarSpotComment?  @relation("SpotCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   CarSpotComment[] @relation("SpotCommentReplies")
  createdAt DateTime         @default(now())

  @@index([spotId])
  @@index([authorId])
  @@index([parentId])
}
